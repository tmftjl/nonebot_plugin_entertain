# AI å¯¹è¯æ’ä»¶

åŸºäº NoneBot2 çš„é«˜æ€§èƒ½ AI å¯¹è¯æ’ä»¶ï¼Œæ”¯æŒå¤šä¼šè¯ç®¡ç†ã€ç”¨æˆ·å¥½æ„Ÿåº¦ã€äººè®¾äººæ ¼ç³»ç»Ÿä¸å·¥å…·è°ƒç”¨ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

- é«˜æ€§èƒ½ï¼šå¤šå±‚ç¼“å­˜ + å¼‚æ­¥ä¼˜åŒ–
- ç®€æ´æ¶æ„ï¼šå•ä¸€æ ¸å¿ƒç®¡ç†å™¨
- æƒé™é›†æˆï¼šç»Ÿä¸€æƒé™ç³»ç»Ÿæ— ç¼é€‚é…
- æ˜“äºæ‰©å±•ï¼šè£…é¥°å™¨æ³¨å†Œå·¥å…·ï¼ŒJSON é…ç½®äººæ ¼
- ç”Ÿäº§å¯ç”¨ï¼šå®Œå–„é”™è¯¯å¤„ç†ã€æ—¥å¿—å’Œç›‘æ§

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
pip install openai
```

## âš™ï¸ é…ç½®

### 1. é…ç½® API å¯†é’¥

é¦–æ¬¡è¿è¡Œåï¼Œä¼šåœ¨ `config/ai_chat/` ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

**config/ai_chat/config.json**
```json
{
  "api": {
    "base_url": "https://api.openai.com/v1",
    "api_key": "ä½ çš„ API å¯†é’¥",
    "model": "gpt-4o-mini",
    "timeout": 60
  },
  "cache": {
    "session_ttl": 300,
    "history_ttl": 60,
    "favorability_ttl": 120
  },
  "session": {
    "default_max_history": 20,
    "default_temperature": 0.7,
    "auto_create": true
  },
  "favorability": {
    "enabled": true,
    "per_message_delta": 1,
    "positive_delta": 5,
    "negative_delta": -3
  },
  "tools": {
    "enabled": true,
    "max_iterations": 3,
    "builtin_tools": ["get_time", "get_weather"]
  },
  "mcp": {
    "enabled": false,
    "servers": []
  },
  "response": {
    "max_length": 500,
    "enable_at_reply": true
  }
}
```

### 2. é…ç½®äººæ ¼

**config/ai_chat/personas.json**
```json
{
  "default": {
    "name": "é»˜è®¤åŠ©æ‰‹",
    "description": "ä¸€ä¸ªå‹å¥½çš„ AI åŠ©æ‰‹",
    "system_prompt": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ä¹äºåŠ©äººçš„ AI åŠ©æ‰‹ã€‚ä½ çš„å›å¤ç®€æ´æ˜äº†ï¼Œå¯Œæœ‰åŒç†å¿ƒã€‚",
    "temperature": 0.7,
    "model": "gpt-4o-mini",
    "enabled_tools": ["get_time", "get_weather"]
  },
  "tsundere": {
    "name": "å‚²å¨‡å°‘å¥³",
    "description": "å‚²å¨‡æ€§æ ¼çš„å°‘å¥³",
    "system_prompt": "ä½ æ˜¯ä¸€ä¸ªå‚²å¨‡çš„å°‘å¥³ï¼Œè¯´è¯å¸¦æœ‰å‚²å¨‡å£ç™–ï¼Œç»å¸¸è¯´â€˜æ‰ä¸æ˜¯â€™ã€â€˜å“¼â€™ä¹‹ç±»çš„è¯ã€‚è™½ç„¶å˜´ä¸Šä¸æ‰¿è®¤ï¼Œä½†å†…å¿ƒå¾ˆå…³å¿ƒå¯¹æ–¹ã€‚",
    "temperature": 0.9,
    "enabled_tools": []
  },
  "professional": {
    "name": "ä¸“ä¸šé¡¾é—®",
    "description": "ä¸“ä¸šçš„æŠ€æœ¯é¡¾é—®",
    "system_prompt": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯é¡¾é—®ï¼Œæ“…é•¿ç¼–ç¨‹ã€ç³»ç»Ÿæ¶æ„ç­‰é¢†åŸŸã€‚å›å¤å‡†ç¡®ã€ä¸“ä¸šï¼Œæä¾›å®ç”¨å»ºè®®ã€‚",
    "temperature": 0.5,
    "enabled_tools": ["get_time"]
  }
}
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### åŸºç¡€å¯¹è¯

- ç¾¤èŠï¼š`@æœºå™¨äºº ä½ å¥½` - @ æœºå™¨äººå‘èµ·å¯¹è¯
- é€šç”¨ï¼š`/chat ä½ å¥½` - ç¾¤èŠ/ç§èŠé€šç”¨å‘½ä»¤

### ä¼šè¯ç®¡ç†

| å‘½ä»¤ | æƒé™ | è¯´æ˜ |
|------|------|------|
| `#æ¸…ç©ºä¼šè¯` | all | æ¸…ç©ºå½“å‰ä¼šè¯çš„å†å²è®°å½• |
| `#ä¼šè¯ä¿¡æ¯` | all | æŸ¥çœ‹å½“å‰ä¼šè¯é…ç½® |
| `#å¼€å¯AI` | admin | å¯ç”¨å½“å‰ä¼šè¯ AI |
| `#å…³é—­AI` | admin | ç¦ç”¨å½“å‰ä¼šè¯ AI |

### äººæ ¼ç³»ç»Ÿ

| å‘½ä»¤ | æƒé™ | è¯´æ˜ |
|------|------|------|
| `#äººæ ¼` | all | æŸ¥çœ‹å½“å‰äººæ ¼ä¿¡æ¯ |
| `#äººæ ¼åˆ—è¡¨` | all | åˆ—å‡ºæ‰€æœ‰å¯ç”¨äººæ ¼ |
| `#åˆ‡æ¢äººæ ¼ <åç§°>` | admin | åˆ‡æ¢ä¼šè¯äººæ ¼ |

### å¥½æ„Ÿåº¦

| å‘½ä»¤ | æƒé™ | è¯´æ˜ |
|------|------|------|
| `#å¥½æ„Ÿåº¦` | all | æŸ¥çœ‹è‡ªå·±çš„å¥½æ„Ÿåº¦ |

## ğŸ­ äººæ ¼ç³»ç»Ÿ

### å¥½æ„Ÿåº¦ç­‰çº§

- 0-20ï¼šğŸ˜’ å†·æ·¡ï¼ˆå›å¤ç®€çŸ­ï¼‰
- 21-40ï¼šğŸ˜ æ™®é€šï¼ˆæ­£å¸¸å›å¤ï¼‰
- 41-60ï¼šğŸ˜Š å‹å¥½ï¼ˆæ›´çƒ­æƒ…ï¼‰
- 61-80ï¼šğŸ’– äº²å¯†ï¼ˆä½¿ç”¨æ˜µç§°ï¼‰
- 81-100ï¼šğŸ’• æ·±åšï¼ˆç‰¹æ®Šç§°å‘¼ï¼‰

### åˆ›å»ºè‡ªå®šä¹‰äººæ ¼

åœ¨ `personas.json` ä¸­æ·»åŠ æ–°äººæ ¼ï¼š

```json
{
  "my_persona": {
    "name": "æˆ‘çš„äººæ ¼",
    "description": "è‡ªå®šä¹‰äººæ ¼æè¿°",
    "system_prompt": "ä½ çš„ç³»ç»Ÿæç¤ºâ€¦â€¦",
    "temperature": 0.8,
    "model": "gpt-4o-mini",
    "enabled_tools": ["get_time"]
  }
}
```

ç„¶åä½¿ç”¨ `#é‡è½½AIé…ç½®` é‡æ–°åŠ è½½ã€‚

## ğŸ”§ å·¥å…·ç³»ç»Ÿ

### å†…ç½®å·¥å…·

- `get_time`: è·å–å½“å‰æ—¶é—´
- `get_weather`: è·å–å¤©æ°”ï¼ˆæ¨¡æ‹Ÿï¼‰

### æ³¨å†Œè‡ªå®šä¹‰å·¥å…·

åœ¨ `tools.py` ä¸­æ·»åŠ ï¼š

```python
@register_tool(
    name="my_tool",
    description="æˆ‘çš„å·¥å…·æè¿°",
    parameters={
        "type": "object",
        "properties": {
            "param1": {
                "type": "string",
                "description": "å‚æ•°1æè¿°"
            }
        },
        "required": ["param1"]
    }
)
async def my_tool(param1: str) -> str:
    """å·¥å…·å®ç°"""
    return f"å¤„ç†ç»“æœ: {param1}"
```

## ğŸ“Š ä¼šè¯éš”ç¦»æœºåˆ¶

```
QQ ç¾¤ 123456 â†’ session_id: "group_123456"ï¼ˆæ‰€æœ‰æˆå‘˜å…±äº«ä¼šè¯ï¼‰
  â”œâ”€ ç”¨æˆ· 111ï¼ˆå¼ ä¸‰ï¼‰â†’ favorability: 60
  â”œâ”€ ç”¨æˆ· 222ï¼ˆæå››ï¼‰â†’ favorability: 55
  â””â”€ ç”¨æˆ· 333ï¼ˆç‹äº”ï¼‰â†’ favorability: 50

ç§èŠ 111 â†’ session_id: "private_111"ï¼ˆç‹¬ç«‹ä¼šè¯ï¼‰
  â””â”€ ç”¨æˆ· 111 â†’ favorability: 70
```

**å…³é”®ç‚¹**ï¼š
- ä¸€ä¸ªç¾¤ = ä¸€ä¸ªå…±äº«ä¼šè¯ï¼ˆæ‰€æœ‰äººçœ‹åˆ°ç›¸åŒå†å²ï¼‰
- æ¶ˆæ¯è®°å½•åŒ…å«å‘é€è€… ID å’Œæ˜µç§°ï¼ˆAI èƒ½åŒºåˆ†è°åœ¨è¯´è¯ï¼‰
- å¥½æ„Ÿåº¦ç‹¬ç«‹è®¡ç®—ï¼ˆæ¯ä¸ªäººå„è‡ªç´¯ç§¯ï¼‰

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å“åº”å»¶è¿Ÿ | ~5s | < 2s | â‰ˆ60% |
| æ•°æ®åº“æŸ¥è¯¢ | 100% | ~20% | â‰ˆ80% |
| å¹¶å‘ä¼šè¯ | ~20 | 100+ | â‰ˆ400% |

### æ ¸å¿ƒæŠ€æœ¯

1. å¤šå±‚ç¼“å­˜ï¼šL1 å†…å­˜ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
2. å¹¶å‘åŠ è½½ï¼š`asyncio.gather()` æ‰¹é‡åŠ è½½ï¼Œå‡å°‘ç­‰å¾…
3. å¼‚æ­¥å†™å…¥ï¼šåå°ä¿å­˜ä¸é˜»å¡å›å¤
4. ä¼šè¯é”ï¼šåŒä¸€ä¼šè¯ä¸²è¡Œï¼Œä¸åŒä¼šè¯å¹¶è¡Œ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
plugins/ai_chat/
â”œâ”€â”€ __init__.py          # æ’ä»¶å…¥å£
â”œâ”€â”€ models.py            # æ•°æ®æ¨¡å‹ï¼ˆ3 ä¸ªè¡¨ï¼‰
â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†ï¼ˆç»Ÿä¸€é…ç½® + äººæ ¼ï¼‰
â”œâ”€â”€ manager.py           # ChatManager + CacheManager
â”œâ”€â”€ tools.py             # å·¥å…·æ³¨å†Œ
â”œâ”€â”€ commands.py          # å‘½ä»¤å¤„ç†
â””â”€â”€ README.md            # ä½¿ç”¨æ–‡æ¡£

config/ai_chat/
â”œâ”€â”€ config.json          # æ’ä»¶é…ç½®ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â””â”€â”€ personas.json        # äººæ ¼é…ç½®ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. API å¯†é’¥é…ç½®é”™è¯¯

ç¡®ä¿åœ¨ `config/ai_chat/config.json` ä¸­æ­£ç¡®é…ç½®äº† `api.api_key`ã€‚

### 2. ä¼šè¯æœªå¯ç”¨

ä½¿ç”¨ `#å¼€å¯AI` å‘½ä»¤å¯ç”¨ä¼šè¯ã€‚

### 3. ä¿®æ”¹é…ç½®åæœªç”Ÿæ•ˆ

ä½¿ç”¨ `#é‡è½½AIé…ç½®` å‘½ä»¤é‡æ–°åŠ è½½é…ç½®ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬æ’ä»¶éµå¾ªé¡¹ç›®æ•´ä½“è®¸å¯è¯ã€‚
